/**
 * Util Method to setup the OpenDSU Tests Library to be accessible within Jest
 * through the {@link process}.opendsu property
 *
 * **must be setup** in ```jest.config.js``` like so:
 *
 * ```javascript
 * module.exports = {
 *     ...
 *      globalSetup: "./node_modules/@glass-project/dsu-utils/jest/jest-setup.js",
 * }
 * ```
 * @throws {Error} if it fails to load OpenDSU or the Test Bindings
 *
 * @async
 * @function setupOpenDSUForJest
 *
 * @memberOf dsu-utils
 */
async function setupOpenDSUForJest(){
    const {cacheOpenDSU} = require('./jest-opendsu-client');
    const path = require("path");

    let openDSU;
    const basePath = process.cwd();

    let pathAdapter = "/"

    try{
        require(path.join(basePath, pathAdapter, 'privatesky/psknode/bundles/testsRuntime.js'));
        openDSU = require("opendsu");
    } catch (e) {
        try {
            require(path.join(basePath, "../", 'privatesky/psknode/bundles/testsRuntime.js'));
            pathAdapter = "../";
            openDSU = require("opendsu");
        } catch (e){
            throw new Error("Could not load OpenDSU on the second path iteration " + e.message);
        }
    }

    if (!openDSU)
        throw new Error("OpenDSU has not been loaded (no error was thrown)");
    console.log("OpenDSU as been loaded");

    let tir;
    try {
        tir = require(path.join(basePath, pathAdapter, 'privatesky/psknode/tests/util/tir'));
    } catch (e) {
        throw new Error("Could not load OpenDSU Test Runner: " + e.message);
    }

    if (!tir)
        throw new Error('The OpenDSU Test bindings have not been loaded')

    cacheOpenDSU({
        opendsu: openDSU,
        tir: tir
    });
}

module.exports = setupOpenDSUForJest;

